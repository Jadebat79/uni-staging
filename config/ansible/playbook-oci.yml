---
- name: Provision Pure OCI Staging Box
  hosts: localhost
  connection: local
  become: true
  vars:
    # --- CONFIGURATION ---
    # Reads OCI-specific config from the env file
    registry_url: "{{ lookup('ini', 'REGISTRY_URL type=properties file=/etc/infra_config.env') }}"
    registry_user: "{{ lookup('ini', 'REGISTRY_USER type=properties file=/etc/infra_config.env') }}"
    registry_token: "{{ lookup('ini', 'REGISTRY_TOKEN type=properties file=/etc/infra_config.env') }}"

    project_root: "{{ lookup('ini', 'PROJECT_ROOT type=properties file=/etc/infra_config.env') }}"
    project_name: "{{ lookup('ini', 'PROJECT_NAME type=properties file=/etc/infra_config.env') | default('staging', true) }}"

    # App Config
    apps_config: "{{ lookup('file', project_root + '/config/apps-config.yml') | from_yaml | default({'apps': []}, true) }}"

  tasks:
    # --- 1. SYSTEM BASICS ---
    - name: Install Dependencies
      apt:
        pkg: [curl, unzip, python3-pip, acl, python3-venv]
        state: present
        update_cache: yes

    # --- 2. INSTALL DOCKER (Deterministic) ---
- name: Install apt prereqs for Docker repo
  apt:
    name:
      - ca-certificates
      - curl
      - gnupg
      - lsb-release
    state: present
    update_cache: yes

- name: Ensure /etc/apt/keyrings exists
  file:
    path: /etc/apt/keyrings
    state: directory
    mode: "0755"

- name: Add Docker GPG key (dearmored keyring)
  shell: |
    set -e
    curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
    chmod a+r /etc/apt/keyrings/docker.gpg
  args:
    creates: /etc/apt/keyrings/docker.gpg

- name: Determine Docker repo arch
  set_fact:
    docker_arch: >-
      {{ 'amd64' if ansible_facts['architecture'] in ['x86_64','amd64'] else
         'arm64' if ansible_facts['architecture'] in ['aarch64','arm64'] else
         ansible_facts['architecture'] }}

- name: Add Docker repository
  apt_repository:
    repo: "deb [arch={{ docker_arch }} signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu {{ ansible_facts['distribution_release'] }} stable"
    state: present
    filename: docker

# This is the part you were missing in a reliable way:
- name: Update apt cache after adding Docker repo
  apt:
    update_cache: yes
    cache_valid_time: 0

- name: Install Docker Engine
  apt:
    name:
      - docker-ce
      - docker-ce-cli
      - containerd.io
      - docker-buildx-plugin
      - docker-compose-plugin
    state: present


# --- 3. OCI SECRETS (Using Instance Principal) ---
- name: Create Env Directory
  file:
    path: "{{ project_root }}/orchestration/env"
    state: directory
    mode: "0755"

- name: Fetch Secrets from OCI Vault
  shell: |
    oci secrets secret-bundle get \
      --secret-id "{{ lookup('ini', 'OCI_SECRET_' + item.name.upper() + '_OCID type=properties file=/etc/infra_config.env') }}" \
      --auth instance_principal \
      --query 'data."secret-bundle-content".content' \
      --raw-output | base64 -d
  loop: "{{ apps_config.apps }}"
  register: oci_secrets
  failed_when: false # Don't crash if a secret is missing

- name: Write .env files
  copy:
    content: "{{ item.stdout }}"
    dest: "{{ project_root }}/orchestration/env/{{ item.item.name }}.env"
  loop: "{{ oci_secrets.results }}"
  when: item.rc == 0

# --- 4. STARTUP (Using OCI Registry) ---
- name: Login to OCIR
  docker_login:
    registry: "{{ registry_url }}"
    username: "{{ registry_user }}"
    password: "{{ registry_token }}"
    reauthorize: yes

- name: Start Docker Compose
  shell: docker compose up -d caddy fluent-bit dozzle
  args:
    chdir: "{{ project_root }}/orchestration"
