---
- name: Provision Universal Staging Box
  hosts: localhost
  connection: local
  become: yes
  vars:
    # --- CONFIGURATION (Reads from /etc/infra_config.env) ---
    # We use 'type=properties' to read the file even without [headers]
    infra_conf: "{{ lookup('ini', 'ECR_URL type=properties file=/etc/infra_config.env') }}"
    project_root: "{{ lookup('ini', 'PROJECT_ROOT type=properties file=/etc/infra_config.env') }}"
    db_pass: "{{ lookup('ini', 'ROOT_DB_PASS type=properties file=/etc/infra_config.env') }}"
    # We infer the region from the ECR URL (e.g. 123.dkr.ecr.us-east-1.amazonaws.com)
    aws_region: "{{ infra_conf.split('.')[3] }}"
    # Hardcode your domain here OR pass it via Terraform/User Data
    root_domain: "teamcanvas.site" 

  tasks:
    # --- 1. SYSTEM PRE-REQUISITES ---
    - name: Install System Dependencies
      apt:
        pkg: [ca-certificates, curl, gnupg, unzip, python3-pip, acl]
        state: present
        update_cache: yes

    # --- 2. INSTALL AWS CLI v2 (The Official Way) ---
    - name: Check if AWS CLI v2 is installed
      stat:
        path: /usr/local/bin/aws
      register: aws_cli_bin

    - name: Download and Install AWS CLI v2
      shell: |
        curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "/tmp/awscliv2.zip"
        unzip -o /tmp/awscliv2.zip -d /tmp
        /tmp/aws/install --update
      when: not aws_cli_bin.stat.exists

    # --- 3. INSTALL DOCKER (The Official Way) ---
    - name: Create Keyring Directory
      file:
        path: /etc/apt/keyrings
        state: directory
        mode: '0755'

    - name: Add Docker GPG Key
      get_url:
        url: https://download.docker.com/linux/ubuntu/gpg
        dest: /etc/apt/keyrings/docker.asc
        mode: '0644'

    - name: Add Docker Repository
      apt_repository:
        repo: "deb [arch=amd64 signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
        filename: docker
        state: present

    - name: Install Docker Engine
      apt:
        pkg: [docker-ce, docker-ce-cli, containerd.io, docker-buildx-plugin, docker-compose-plugin]
        state: present
        update_cache: yes

    - name: Start Docker Service
      service: name=docker state=started enabled=yes

    - name: Add ubuntu user to docker group
      user: name=ubuntu groups=docker append=yes

    # --- 4. ORCHESTRATION SETUP ---
    - name: Create Directories
      file:
        path: "{{ item }}"
        state: directory
        mode: "0755"
        owner: ubuntu
      loop:
        - "{{ project_root }}/orchestration/env"
        - "{{ project_root }}/orchestration/pg_data"
        - "{{ project_root }}/orchestration/caddy_data"

    # --- 5. CONFIGURATION FIXES ---
    - name: Generate Production .env file
      copy:
        content: |
          # Generated by Ansible
          ECR_URL={{ infra_conf }}
          ROOT_DB_PASS={{ db_pass }}
        dest: "{{ project_root }}/orchestration/.env"
        owner: ubuntu
        mode: "0600"

    - name: Update Caddyfile Domain Name
      replace:
        path: "{{ project_root }}/orchestration/Caddyfile"
        regexp: '<domain>'
        replace: "{{ root_domain }}"
      # This fixes the "subject does not qualify for certificate" error

    # --- 6. AUTHENTICATION & STARTUP ---
    - name: Login to AWS ECR
      shell: |
        aws ecr get-login-password --region {{ aws_region }} | docker login --username AWS --password-stdin {{ infra_conf }}
      register: ecr_login
      retries: 3
      delay: 5
      until: ecr_login.rc == 0

    - name: Start Infrastructure (Caddy & DB)
      shell: |
        docker compose up -d caddy db
      args:
        chdir: "{{ project_root }}/orchestration"