---
- name: Provision Universal Staging Box
  hosts: localhost
  connection: local
  become: yes
  vars:
    # Read variables generated by user_data.sh
    infra_conf: "{{ lookup('ini', 'ECR_URL file=/etc/infra_config.env') }}"
    project_root: "{{ lookup('ini', 'PROJECT_ROOT file=/etc/infra_config.env') }}"
    db_pass: "{{ lookup('ini', 'ROOT_DB_PASS file=/etc/infra_config.env') }}"

  tasks:
    # --- Docker Setup ---
    - name: Install Docker Dependencies
      apt:
        pkg: [docker.io, docker-compose-plugin]
        state: present
        update_cache: yes

    - name: Start Docker Service
      service: name=docker state=started enabled=yes

    - name: Add ubuntu user to docker group
      user: name=ubuntu groups=docker append=yes

    # --- Folder Structure ---
    - name: Create Orchestration Directories
      file:
        path: "{{ item }}"
        state: directory
        mode: "0755"
        owner: ubuntu
      loop:
        - "{{ project_root }}/orchestration/env"
        - "{{ project_root }}/orchestration/pg_data"
        - "{{ project_root }}/orchestration/caddy_data"

    # --- Environment Configuration ---
    - name: Generate Production .env file
      copy:
        content: |
          # Generated by Ansible
          ECR_URL={{ infra_conf }}
          ROOT_DB_PASS={{ db_pass }}
        dest: "{{ project_root }}/orchestration/.env"
        owner: ubuntu
        mode: "0600"

    # --- Start Infrastructure ---
    # We start DB and Caddy immediately. Apps will fail until images are pushed.
    - name: Start Base Services
      shell: |
        docker compose up -d caddy db
      args:
        chdir: "{{ project_root }}/orchestration"

    # In playbook.yml tasks:

    - name: Fetch Secret from OCI (If OCI)
      shell: |
        oci secrets secret-bundle get --secret-id <SECRET_OCID> --auth instance_principal --stage CURRENT --query "data.\"secret-bundle-content\".content" --raw-output | base64 --decode > {{ project_root }}/orchestration/env/hikegh.env
      when: lookup('env', 'OCI_AUTH_TYPE') == 'instance_principal'
